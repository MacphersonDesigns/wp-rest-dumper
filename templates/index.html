<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>WordPress REST Dumper</title>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
					sans-serif;
				max-width: 900px;
				margin: 20px auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				background: white;
				padding: 30px;
				border-radius: 10px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			}
			h1 {
				color: #333;
				text-align: center;
				margin-bottom: 30px;
			}
			.form-group {
				margin-bottom: 20px;
			}
			label {
				display: block;
				margin-bottom: 5px;
				font-weight: 500;
				color: #555;
			}
			input[type="text"],
			input[type="password"],
			input[type="number"],
			select {
				width: 100%;
				padding: 10px;
				border: 2px solid #ddd;
				border-radius: 5px;
				font-size: 14px;
				box-sizing: border-box;
			}
			input[type="text"]:focus,
			input[type="password"]:focus,
			input[type="number"]:focus {
				border-color: #007cba;
				outline: none;
			}
			.checkbox-group {
				display: flex;
				flex-wrap: wrap;
				gap: 20px;
				margin-top: 10px;
			}
			.checkbox-item {
				display: flex;
				align-items: center;
			}
			.checkbox-item input[type="checkbox"] {
				margin-right: 8px;
			}
			.auth-section {
				background: #f8f9fa;
				padding: 20px;
				border-radius: 5px;
				border: 1px solid #e9ecef;
				margin-bottom: 20px;
			}
			.auth-section.disabled {
				opacity: 0.6;
			}
			.button-group {
				text-align: center;
				margin: 30px 0;
			}
			button {
				background: #007cba;
				color: white;
				border: none;
				padding: 12px 24px;
				border-radius: 5px;
				font-size: 16px;
				cursor: pointer;
				margin: 0 10px;
				transition: background 0.2s;
			}
			button:hover:not(:disabled) {
				background: #005a8b;
			}
			button:disabled {
				background: #ccc;
				cursor: not-allowed;
			}
			.secondary {
				background: #6c757d;
			}
			.secondary:hover:not(:disabled) {
				background: #545b62;
			}
			.success {
				background: #28a745;
			}
			.success:hover:not(:disabled) {
				background: #1e7e34;
			}
			#output {
				background: #000;
				color: #0f0;
				font-family: "Courier New", monospace;
				padding: 20px;
				border-radius: 5px;
				height: 300px;
				overflow-y: auto;
				white-space: pre-line;
				font-size: 12px;
				line-height: 1.6;
				word-wrap: break-word;
				overflow-wrap: break-word;
			}
			.status-bar {
				background: #e9ecef;
				padding: 10px;
				border-radius: 5px;
				margin: 20px 0;
				font-weight: 500;
				text-align: center;
			}
			.progress-bar {
				width: 100%;
				height: 4px;
				background: #e9ecef;
				border-radius: 2px;
				overflow: hidden;
				margin: 10px 0;
			}
			.progress-fill {
				height: 100%;
				background: #007cba;
				animation: progress 2s linear infinite;
				display: none;
			}
			@keyframes progress {
				0% {
					transform: translateX(-100%);
				}
				100% {
					transform: translateX(400%);
				}
			}
			.row {
				display: flex;
				gap: 20px;
			}
			.col {
				flex: 1;
			}
			.file-input-group {
				display: flex;
				gap: 10px;
				align-items: stretch;
			}
			.file-input-group input {
				flex: 1;
				margin: 0;
			}
			.browse-btn {
				background: #6c757d;
				color: white;
				border: none;
				padding: 10px 15px;
				border-radius: 5px;
				font-size: 14px;
				cursor: pointer;
				white-space: nowrap;
				margin: 0;
			}
			.browse-btn:hover {
				background: #545b62;
			}

			/* Modal styles for directory browser */
			.modal {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
			}

			.modal-content {
				background-color: white;
				margin: 5% auto;
				padding: 20px;
				border-radius: 10px;
				width: 80%;
				max-width: 600px;
				max-height: 70vh;
				overflow: hidden;
				display: flex;
				flex-direction: column;
			}

			.modal-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
			}

			.close {
				color: #aaa;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}

			.close:hover {
				color: black;
			}

			.directory-list {
				flex: 1;
				overflow-y: auto;
				border: 1px solid #ddd;
				border-radius: 5px;
				max-height: 300px;
			}

			.directory-item {
				padding: 10px;
				border-bottom: 1px solid #eee;
				cursor: pointer;
				display: flex;
				align-items: center;
			}

			.directory-item:hover {
				background-color: #f5f5f5;
			}

			.directory-item.selected {
				background-color: #e3f2fd;
			}

			.directory-icon {
				margin-right: 8px;
				font-size: 16px;
			}

			.modal-footer {
				margin-top: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.current-path {
				font-family: monospace;
				background: #f5f5f5;
				padding: 5px 10px;
				border-radius: 3px;
				font-size: 12px;
				flex: 1;
				margin-right: 10px;
			}

			/* Tab styles */
			.tab-btn {
				transition: all 0.2s ease;
			}
			.tab-btn:hover {
				color: #007cba !important;
				background-color: rgba(0, 124, 186, 0.05) !important;
			}
			.tab-btn.active {
				color: #007cba !important;
				border-bottom-color: #007cba !important;
			}
			
			.tab-content {
				animation: fadeIn 0.3s ease-in-out;
			}
			
			@keyframes fadeIn {
				from { opacity: 0; transform: translateY(10px); }
				to { opacity: 1; transform: translateY(0); }
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>üîÑ WordPress REST Dumper</h1>

			<!-- Tab Navigation -->
			<div style="margin-bottom: 30px; border-bottom: 2px solid #e9ecef;">
				<div style="display: flex; gap: 0;">
					<button type="button" class="tab-btn active" onclick="switchTab('bulk')" style="background: none; border: none; padding: 15px 25px; font-size: 16px; font-weight: 500; color: #007cba; border-bottom: 3px solid #007cba; cursor: pointer;">
						üåê Full Site Analysis
					</button>
					<button type="button" class="tab-btn" onclick="switchTab('single')" style="background: none; border: none; padding: 15px 25px; font-size: 16px; font-weight: 500; color: #666; border-bottom: 3px solid transparent; cursor: pointer;">
						üìÑ Single Page Extract
					</button>
				</div>
			</div>

			<!-- Bulk Analysis Tab -->
			<div id="bulkTab" class="tab-content">
				<form id="scraperForm">
				<div class="form-group">
					<label for="url">Website URL *</label>
					<input
						type="text"
						id="url"
						name="url"
						placeholder="https://example.com"
						required />
				</div>

				<div class="auth-section" id="authSection">
					<div class="form-group">
						<div class="checkbox-item">
							<input type="checkbox" id="useAuth" name="useAuth" />
							<label for="useAuth"
								>Use Authentication (for protected content)</label
							>
						</div>
					</div>

					<div class="row">
						<div class="col">
							<div class="form-group">
								<label for="username">Username</label>
								<input type="text" id="username" name="username" disabled />
							</div>
						</div>
						<div class="col">
							<div class="form-group">
								<label for="password">Password</label>
								<input type="password" id="password" name="password" disabled />
							</div>
						</div>
					</div>
				</div>

				<div class="form-group">
					<label>Scraping Options</label>
					<div class="checkbox-group">
						<div class="checkbox-item">
							<input type="checkbox" id="allTypes" name="allTypes" />
							<label for="allTypes">Include all content types</label>
						</div>
						<div class="checkbox-item">
							<input type="checkbox" id="skipMedia" name="skipMedia" />
							<label for="skipMedia">Skip media downloads</label>
						</div>
						<div class="checkbox-item">
							<input type="checkbox" id="verbose" name="verbose" />
							<label for="verbose">Verbose output</label>
						</div>
					</div>
				</div>

				<div class="form-group">
					<label>üöÄ Content Intelligence & Analysis</label>
					<div class="checkbox-group">
						<div class="checkbox-item">
							<input
								type="checkbox"
								id="runAnalytics"
								name="runAnalytics"
								checked />
							<label for="runAnalytics"
								>üìä Generate content analytics dashboard</label
							>
						</div>
						<div class="checkbox-item">
							<input
								type="checkbox"
								id="runSeoAnalysis"
								name="runSeoAnalysis"
								checked />
							<label for="runSeoAnalysis">üéØ Create SEO analysis report</label>
						</div>
						<div class="checkbox-item">
							<input
								type="checkbox"
								id="createMaster"
								name="createMaster"
								checked />
							<label for="createMaster">üé® Generate master dashboard</label>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col">
						<div class="form-group">
							<label for="outputDir">Save Location</label>
							<div class="file-input-group">
								<input
									type="text"
									id="outputDir"
									name="outputDir"
									value="wp_dump"
									placeholder="e.g., /Users/yourname/Downloads/scraped_sites" />
								<button
									type="button"
									class="browse-btn"
									onclick="browseFolder()">
									üìÅ Browse
								</button>
							</div>
							<small style="color: #666; font-size: 12px">
								üí° Each website will create its own subfolder here (e.g.,
								wp_dump/site-name/)
							</small>
						</div>
					</div>
					<div class="col">
						<div class="form-group">
							<label for="sleepTime">Delay Between Requests (seconds)</label>
							<input
								type="number"
								id="sleepTime"
								name="sleepTime"
								value="0.2"
								min="0.1"
								max="5"
								step="0.1" />
						</div>
					</div>
				</div>
			</form>

			<div class="button-group">
				<button type="button" id="startBtn" onclick="startScraping()">
					üöÄ Start Complete Analysis
				</button>
				<button
					type="button"
					id="zipBtn"
					onclick="downloadZip()"
					disabled
					class="success">
					üì¶ Download ZIP
				</button>
				<button type="button" onclick="clearOutput()" class="secondary">
					üóëÔ∏è Clear Output
				</button>
			</div>

			<div class="button-group" style="margin-top: 10px">
				<button
					type="button"
					onclick="runAnalyticsOnly()"
					class="secondary"
					disabled
					id="analyticsBtn">
					üìä Analytics Only
				</button>
				<button
					type="button"
					onclick="runSeoOnly()"
					class="secondary"
					disabled
					id="seoBtn">
					üéØ SEO Analysis Only
				</button>
				<button
					type="button"
					onclick="openDashboard()"
					class="secondary"
					disabled
					id="dashboardBtn">
					üåü Open Dashboard
				</button>
			</div>

			<div class="status-bar" id="statusBar">Ready</div>

			<div class="progress-bar">
				<div class="progress-fill" id="progressBar"></div>
			</div>

			<div class="form-group">
				<label for="output">Output</label>
				<div id="output">
					üöÄ Welcome to WordPress Content Intelligence Suite! üéâ NEW ADVANCED
					FEATURES: ‚Ä¢ üìù Triple Output Formats: Raw, Enhanced Pretty, and
					Markdown ‚Ä¢ üé® Smart Shortcode Cleaning: Removes VC/Elementor/Divi
					codes ‚Ä¢ üîç Business Data Extraction: Auto-extracts dealers, contacts,
					addresses as JSON ‚Ä¢ üìä Content Analytics Dashboard: Word counts,
					readability, insights ‚Ä¢ üéØ SEO Analysis Report: Meta tags, keywords,
					optimization tips ‚Ä¢ üåü Master Dashboard: Unified beautiful interface
					for all reports üí° How to Use: 1. Enter your WordPress site URL above
					2. Enable authentication for protected content (optional) 3. Choose
					analysis options (analytics & SEO recommended) 4. Click "Start
					Complete Analysis" and watch the magic happen! 5. Download your ZIP
					with all reports and extracted content üîß Output Includes: ‚Ä¢ Raw text
					files (clean text extraction) ‚Ä¢ Pretty text files (enhanced with
					structured data) ‚Ä¢ Markdown files (beautiful formatted content) ‚Ä¢
					Analytics dashboard (interactive HTML report) ‚Ä¢ SEO analysis report
					(optimization recommendations) ‚Ä¢ Master dashboard (combines everything
					beautifully) Ready to extract and analyze? Enter a URL above! ‚¨ÜÔ∏è -
					Verbose output shows detailed progress information
				</div>
			</div>
			</div>

			<!-- Single Page Extract Tab -->
			<div id="singleTab" class="tab-content" style="display: none;">
				<form id="singlePageForm">
					<div class="form-group">
						<label for="singlePageUrl">Single Page URL *</label>
						<input
							type="text"
							id="singlePageUrl"
							name="singlePageUrl"
							placeholder="https://example.com/specific-page/"
							required />
						<small style="color: #666; font-size: 12px;">
							üí° Enter the full URL of a specific WordPress page or post
						</small>
					</div>

					<div class="auth-section" id="singleAuthSection">
						<div class="form-group">
							<div class="checkbox-item">
								<input type="checkbox" id="singleUseAuth" name="singleUseAuth" />
								<label for="singleUseAuth"
									>Use Authentication (for protected content)</label
								>
							</div>
						</div>

						<div class="row">
							<div class="col">
								<div class="form-group">
									<label for="singleUsername">Username</label>
									<input type="text" id="singleUsername" name="singleUsername" disabled />
								</div>
							</div>
							<div class="col">
								<div class="form-group">
									<label for="singlePassword">Password</label>
									<input type="password" id="singlePassword" name="singlePassword" disabled />
								</div>
							</div>
						</div>
					</div>

					<div class="form-group">
						<label>üìä Data Export Options</label>
						<div class="checkbox-group">
							<div class="checkbox-item">
								<input type="checkbox" id="singleDetailed" name="singleDetailed" checked />
								<label for="singleDetailed">Create detailed CSV files (recommended)</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="singleVerbose" name="singleVerbose" />
								<label for="singleVerbose">Verbose output</label>
							</div>
						</div>
						<small style="color: #666; font-size: 12px;">
							üí° Detailed mode creates separate CSV files for headings, links, images, and business data
						</small>
					</div>

					<div class="form-group">
						<label for="singleOutputDir">Save Location</label>
						<div class="file-input-group">
							<input
								type="text"
								id="singleOutputDir"
								name="singleOutputDir"
								value="single_page_extracts"
								placeholder="e.g., /Users/yourname/Downloads/page_extracts" />
							<button
								type="button"
								class="browse-btn"
								onclick="browseSingleFolder()">
								üìÅ Browse
							</button>
						</div>
						<small style="color: #666; font-size: 12px">
							üí° CSV files will be saved to this directory with a timestamp
						</small>
					</div>
				</form>

				<div class="button-group">
					<button type="button" id="singleExtractBtn" onclick="extractSinglePage()">
						üìÑ Extract Page Data to CSV
					</button>
					<button type="button" onclick="clearSingleOutput()" class="secondary">
						üóëÔ∏è Clear Output
					</button>
				</div>

				<div class="status-bar" id="singleStatusBar">Ready for single page extraction</div>

				<div class="progress-bar">
					<div class="progress-fill" id="singleProgressBar"></div>
				</div>

				<div class="form-group">
					<label for="singleOutput">Single Page Extraction Output</label>
					<div id="singleOutput">
						üìÑ Single Page Data Extractor üìä

						üéØ What this tool extracts:
						‚Ä¢ Basic page info (title, URL, dates, author)
						‚Ä¢ Content analysis (word count, headings, paragraphs, links)
						‚Ä¢ SEO data (meta tags, Open Graph, schema markup)
						‚Ä¢ Business data (contact info, addresses, phone numbers)
						‚Ä¢ Media information (images, videos, alt text)
						‚Ä¢ Form data (contact forms, fields, actions)

						üíæ CSV Output Options:
						‚Ä¢ Simple mode: Single CSV with summary data
						‚Ä¢ Detailed mode: Multiple CSV files for different data types
						  - page_summary.csv (main page data)
						  - headings.csv (all headings with levels)
						  - links.csv (internal/external links)
						  - images.csv (image sources and alt text)
						  - business_data.csv (extracted business listings)

						Ready to extract? Enter a page URL above! ‚¨ÜÔ∏è
					</div>
				</div>
			</div>
		</div>

		<!-- Directory Browser Modal -->
		<div id="directoryModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>üìÅ Select Save Location</h3>
					<span class="close" onclick="closeDirectoryBrowser()">&times;</span>
				</div>
				<div id="directoryList" class="directory-list">
					<div id="loadingIndicator" style="padding: 20px; text-align: center">
						Loading directories...
					</div>
				</div>
				<div class="modal-footer">
					<div class="current-path" id="currentPath">/</div>
					<button
						type="button"
						onclick="selectCurrentDirectory()"
						id="selectBtn"
						disabled>
						‚úì Select This Folder
					</button>
				</div>
			</div>
		</div>

		<script>
			let isScrapingActive = false;
			let isSingleExtracting = false;

			// Tab switching functionality
			function switchTab(tabName) {
				// Update tab buttons
				document.querySelectorAll('.tab-btn').forEach(btn => {
					btn.classList.remove('active');
					btn.style.color = '#666';
					btn.style.borderBottomColor = 'transparent';
				});
				
				// Hide all tab contents
				document.querySelectorAll('.tab-content').forEach(content => {
					content.style.display = 'none';
				});
				
				// Show selected tab
				if (tabName === 'bulk') {
					document.getElementById('bulkTab').style.display = 'block';
					document.querySelector('[onclick="switchTab(\'bulk\')"]').classList.add('active');
					document.querySelector('[onclick="switchTab(\'bulk\')"]').style.color = '#007cba';
					document.querySelector('[onclick="switchTab(\'bulk\')"]').style.borderBottomColor = '#007cba';
				} else if (tabName === 'single') {
					document.getElementById('singleTab').style.display = 'block';
					document.querySelector('[onclick="switchTab(\'single\')"]').classList.add('active');
					document.querySelector('[onclick="switchTab(\'single\')"]').style.color = '#007cba';
					document.querySelector('[onclick="switchTab(\'single\')"]').style.borderBottomColor = '#007cba';
				}
			}

			// Toggle authentication fields
			document
				.getElementById("useAuth")
				.addEventListener("change", function () {
					const isEnabled = this.checked;
					const authSection = document.getElementById("authSection");
					const username = document.getElementById("username");
					const password = document.getElementById("password");

					username.disabled = !isEnabled;
					password.disabled = !isEnabled;
					authSection.classList.toggle("disabled", !isEnabled);
				});

			// Toggle authentication fields for single page extraction
			document
				.getElementById("singleUseAuth")
				.addEventListener("change", function () {
					const isEnabled = this.checked;
					const authSection = document.getElementById("singleAuthSection");
					const username = document.getElementById("singleUsername");
					const password = document.getElementById("singlePassword");

					username.disabled = !isEnabled;
					password.disabled = !isEnabled;
					authSection.classList.toggle("disabled", !isEnabled);
				});

			// Auto-format URL
			document.getElementById("url").addEventListener("blur", function () {
				let url = this.value.trim();
				if (url && !url.match(/^https?:\/\//i)) {
					this.value = "https://" + url;
				}
			});

			// Auto-format single page URL
			document.getElementById("singlePageUrl").addEventListener("blur", function () {
				let url = this.value.trim();
				if (url && !url.match(/^https?:\/\//i)) {
					this.value = "https://" + url;
				}
			});

			function appendOutput(message) {
				const output = document.getElementById("output");
				output.textContent += message;
				output.scrollTop = output.scrollHeight;
			}

			function appendSingleOutput(message) {
				const output = document.getElementById("singleOutput");
				output.textContent += message;
				output.scrollTop = output.scrollHeight;
			}

			function clearOutput() {
				document.getElementById("output").textContent = "";
			}

			function clearSingleOutput() {
				document.getElementById("singleOutput").textContent = "";
			}

			function setStatus(status) {
				document.getElementById("statusBar").textContent = status;
			}

			function setSingleStatus(status) {
				document.getElementById("singleStatusBar").textContent = status;
			}

			function setProgress(visible) {
				document.getElementById("progressBar").style.display = visible
					? "block"
					: "none";
			}

			function setSingleProgress(visible) {
				document.getElementById("singleProgressBar").style.display = visible
					? "block"
					: "none";
			}

			function validateForm() {
				const url = document.getElementById("url").value.trim();
				if (!url) {
					alert("Please enter a website URL");
					return false;
				}

				const useAuth = document.getElementById("useAuth").checked;
				if (useAuth) {
					const username = document.getElementById("username").value.trim();
					const password = document.getElementById("password").value.trim();
					if (!username || !password) {
						alert("Please enter both username and password for authentication");
						return false;
					}
				}

				return true;
			}

			function validateSinglePageForm() {
				const url = document.getElementById("singlePageUrl").value.trim();
				if (!url) {
					alert("Please enter a page URL");
					return false;
				}

				const useAuth = document.getElementById("singleUseAuth").checked;
				if (useAuth) {
					const username = document.getElementById("singleUsername").value.trim();
					const password = document.getElementById("singlePassword").value.trim();
					if (!username || !password) {
						alert("Please enter both username and password for authentication");
						return false;
					}
				}

				return true;
			}

			async function extractSinglePage() {
				if (!validateSinglePageForm() || isSingleExtracting) return;

				const form = document.getElementById("singlePageForm");
				const formData = new FormData(form);

				// Convert to JSON
				const data = {};
				for (let [key, value] of formData.entries()) {
					if (form.elements[key] && form.elements[key].type === "checkbox") {
						data[key] = form.elements[key].checked;
					} else {
						data[key] = value;
					}
				}

				isSingleExtracting = true;
				document.getElementById("singleExtractBtn").disabled = true;
				setSingleStatus("Extracting page data...");
				setSingleProgress(true);
				clearSingleOutput();

				try {
					appendSingleOutput("\nüîç Starting single page data extraction...");
					appendSingleOutput(`\nüìÑ Target URL: ${data.singlePageUrl}`);
					
					const response = await fetch("/extract-single-page", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(data),
					});

					const result = await response.json();

					if (result.success) {
						appendSingleOutput("\n‚úÖ Page data extracted successfully!");
						appendSingleOutput(`\nüìä Files created: ${result.files.length}`);
						result.files.forEach(file => {
							appendSingleOutput(`\n   üìÑ ${file}`);
						});
						
						if (result.summary) {
							appendSingleOutput(`\n\nüìä Page Summary:`);
							appendSingleOutput(`\n   Title: ${result.summary.title}`);
							appendSingleOutput(`\n   Type: ${result.summary.type}`);
							appendSingleOutput(`\n   Words: ${result.summary.word_count}`);
							appendSingleOutput(`\n   Headings: ${result.summary.heading_count}`);
							appendSingleOutput(`\n   Links: ${result.summary.link_count}`);
							appendSingleOutput(`\n   Images: ${result.summary.image_count}`);
							if (result.summary.business_count > 0) {
								appendSingleOutput(`\n   Business listings: ${result.summary.business_count}`);
							}
						}
						
						setSingleStatus("Extraction completed successfully!");
					} else {
						appendSingleOutput(`\n‚ùå Extraction failed: ${result.error}`);
						setSingleStatus("Extraction failed");
					}
				} catch (error) {
					appendSingleOutput("\n‚ùå Error: " + error.message);
					setSingleStatus("Error during extraction");
				} finally {
					isSingleExtracting = false;
					document.getElementById("singleExtractBtn").disabled = false;
					setSingleProgress(false);
				}
			}

			function browseSingleFolder() {
				// Use the same folder browser but update the single page field
				currentSingleBrowsing = true;
				document.getElementById("directoryModal").style.display = "block";
				loadDirectories("");
			}

			let currentSingleBrowsing = false;

			async function startScraping() {
				if (!validateForm() || isScrapingActive) return;

				const form = document.getElementById("scraperForm");
				const formData = new FormData(form);

				// Convert to JSON
				const data = {};
				for (let [key, value] of formData.entries()) {
					if (form.elements[key].type === "checkbox") {
						data[key] = form.elements[key].checked;
					} else {
						data[key] = value;
					}
				}

				isScrapingActive = true;
				document.getElementById("startBtn").disabled = true;
				document.getElementById("zipBtn").disabled = true;
				setStatus("Scraping in progress...");
				setProgress(true);
				clearOutput();

				try {
					const response = await fetch("/scrape", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(data),
					});

					// Start polling for updates
					pollForUpdates();
				} catch (error) {
					appendOutput("\nError: " + error.message);
					scrapingComplete(false);
				}
			}

			async function pollForUpdates() {
				try {
					const response = await fetch("/status");
					const data = await response.json();

					// Append new output messages
					if (data.messages && data.messages.length > 0) {
						for (const message of data.messages) {
							// Clean up message formatting
							let cleanMessage = message
								.replace(/\r\n/g, "\n") // Normalize line endings
								.replace(/\r/g, "\n") // Normalize line endings
								.trim(); // Remove leading/trailing whitespace

							if (cleanMessage) {
								// Only append non-empty messages
								appendOutput(cleanMessage + "\n");
							}
						}
					}
					setStatus(data.status);

					if (data.scraping_active) {
						// Continue polling
						setTimeout(pollForUpdates, 1000);
					} else {
						scrapingComplete(data.success, data.output_dir);
					}
				} catch (error) {
					console.error("Polling error:", error);
					setTimeout(pollForUpdates, 2000); // Retry after longer delay
				}
			}

			function scrapingComplete(success, outputDir) {
				isScrapingActive = false;
				document.getElementById("startBtn").disabled = false;
				setProgress(false);

				if (success && outputDir) {
					document.getElementById("zipBtn").disabled = false;
					document.getElementById("analyticsBtn").disabled = false;
					document.getElementById("seoBtn").disabled = false;
					document.getElementById("dashboardBtn").disabled = false;
					setStatus("Complete analysis finished! ZIP file and reports ready.");
					appendOutput("\n\n‚úÖ Complete analysis finished successfully!");
					appendOutput("\nüìä Analytics Dashboard: Available in ZIP");
					appendOutput("\nüéØ SEO Report: Available in ZIP");
					appendOutput("\nüåü Master Dashboard: Available in ZIP");
				} else {
					setStatus("Analysis failed - check output for details.");
					appendOutput("\n\n‚ùå Analysis failed.");
				}
			}

			async function runAnalyticsOnly() {
				appendOutput("\nüìä Running content analytics...");
				try {
					const response = await fetch("/analytics-only", { method: "POST" });
					const result = await response.json();
					if (result.success) {
						appendOutput(`\n‚úÖ Analytics report generated: ${result.file}`);
					} else {
						appendOutput(`\n‚ùå Analytics failed: ${result.error}`);
					}
				} catch (error) {
					appendOutput(`\n‚ùå Analytics error: ${error.message}`);
				}
			}

			async function runSeoOnly() {
				appendOutput("\nüéØ Running SEO analysis...");
				try {
					const response = await fetch("/seo-only", { method: "POST" });
					const result = await response.json();
					if (result.success) {
						appendOutput(`\n‚úÖ SEO report generated: ${result.file}`);
					} else {
						appendOutput(`\n‚ùå SEO analysis failed: ${result.error}`);
					}
				} catch (error) {
					appendOutput(`\n‚ùå SEO analysis error: ${error.message}`);
				}
			}

			function openDashboard() {
				appendOutput("\nüåü Opening master dashboard in new window...");
				window.open("/dashboard", "_blank");
			}

			async function downloadZip() {
				try {
					setStatus("Creating ZIP file...");
					setProgress(true);

					const response = await fetch("/create-zip", { method: "POST" });

					if (response.ok) {
						// Trigger download
						const blob = await response.blob();
						const url = window.URL.createObjectURL(blob);
						const a = document.createElement("a");
						a.style.display = "none";
						a.href = url;
						a.download =
							response.headers
								.get("Content-Disposition")
								?.split("filename=")[1] || "wordpress_dump.zip";
						document.body.appendChild(a);
						a.click();
						window.URL.revokeObjectURL(url);

						setStatus("ZIP file downloaded successfully!");
						appendOutput("\nüì¶ ZIP file downloaded to your Downloads folder");
					} else {
						throw new Error("Failed to create ZIP file");
					}
				} catch (error) {
					setStatus("ZIP creation failed");
					appendOutput("\n‚ùå Error creating ZIP: " + error.message);
				} finally {
					setProgress(false);
				}
			}

			let currentBrowsingPath = "";
			let selectedPath = "";

			function browseFolder() {
				document.getElementById("directoryModal").style.display = "block";
				loadDirectories("");
			}

			function closeDirectoryBrowser() {
				document.getElementById("directoryModal").style.display = "none";
			}

			async function loadDirectories(path) {
				const listContainer = document.getElementById("directoryList");
				const currentPathElement = document.getElementById("currentPath");
				const selectBtn = document.getElementById("selectBtn");

				// Show loading
				listContainer.innerHTML =
					'<div style="padding: 20px; text-align: center;">Loading directories...</div>';

				try {
					const response = await fetch(
						`/browse?path=${encodeURIComponent(path)}`
					);
					const data = await response.json();

					if (data.error) {
						listContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">Error: ${data.error}</div>`;
						return;
					}

					currentBrowsingPath = data.current_path;
					currentPathElement.textContent = data.current_path || "Root";
					selectBtn.disabled = !data.can_select;

					// Clear and populate directory list
					listContainer.innerHTML = "";

					data.directories.forEach((dir) => {
						const item = document.createElement("div");
						item.className = "directory-item";
						item.onclick = () => {
							if (dir.type === "parent") {
								loadDirectories(dir.path);
							} else if (dir.type === "directory") {
								loadDirectories(dir.path);
							}
						};

						const icon = dir.type === "parent" ? "‚Ü©Ô∏è" : "üìÅ";
						item.innerHTML = `
							<span class="directory-icon">${icon}</span>
							<span>${dir.name}</span>
						`;

						listContainer.appendChild(item);
					});

					if (data.directories.length === 0) {
						listContainer.innerHTML =
							'<div style="padding: 20px; text-align: center; color: #666;">No accessible directories found</div>';
					}
				} catch (error) {
					listContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">Error loading directories: ${error.message}</div>`;
				}
			}

			function selectCurrentDirectory() {
				if (currentBrowsingPath) {
					if (currentSingleBrowsing) {
						document.getElementById("singleOutputDir").value = currentBrowsingPath;
						currentSingleBrowsing = false;
					} else {
						document.getElementById("outputDir").value = currentBrowsingPath;
					}
					closeDirectoryBrowser();
				}
			}

			// Close modal when clicking outside
			window.onclick = function (event) {
				const modal = document.getElementById("directoryModal");
				if (event.target === modal) {
					closeDirectoryBrowser();
				}
			};
		</script>
	</body>
</html>
